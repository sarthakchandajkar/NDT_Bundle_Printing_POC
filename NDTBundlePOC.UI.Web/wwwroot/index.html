<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIoT (PAS) - NDT Bundle Tag Printing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: white;
            min-height: 100vh;
            font-size: 9pt;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: #F0F0F0;
            height: 40px;
            padding: 0 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #ddd;
        }

        .header-title {
            font-size: 10pt;
            font-weight: bold;
            color: black;
        }

        .header-datetime {
            font-size: 9pt;
            color: black;
        }

        .header-heartbeat {
            font-size: 9pt;
            margin-right: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .heartbeat-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .heartbeat-online {
            background-color: #28a745;
            box-shadow: 0 0 5px #28a745;
        }

        .heartbeat-waiting {
            background-color: #ffc107;
            box-shadow: 0 0 5px #ffc107;
        }

        .heartbeat-error {
            background-color: #dc3545;
            box-shadow: 0 0 5px #dc3545;
        }

        .heartbeat-disconnected {
            background-color: #6c757d;
        }

        .heartbeat-status {
            font-weight: bold;
        }

        .heartbeat-value {
            font-family: monospace;
            color: #666;
        }

        /* Filter Panel */
        .filter-panel {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .filter-label {
            width: 50px;
            font-size: 9pt;
        }

        .filter-control {
            padding: 3px 5px;
            border: 1px solid #DEDEE0;
            border-radius: 3px;
            font-size: 8pt;
            height: 20px;
        }

        .filter-control.large {
            width: 180px;
        }

        .filter-control.medium {
            width: 150px;
        }

        .filter-control.small {
            width: 60px;
        }

        .filter-control.pipe {
            width: 90px;
        }

        .btn {
            padding: 3px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 8pt;
            height: 22px;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #0078D7;
            color: white;
        }

        .btn-primary:hover {
            background: #0066BB;
        }

        .btn-primary-bold {
            background: #0078D7;
            color: white;
            font-weight: bold;
        }

        .btn-orange {
            background: #FF8C00;
            color: white;
        }

        .btn-orange:hover {
            background: #E67A00;
        }

        .btn-shop {
            width: 80px;
            height: 22px;
            background: #F0F0F0;
            color: black;
            border: 1px solid #ddd;
        }

        .btn-shop.active {
            background: #3BB9FF;
            color: black;
        }

        .filter-actions {
            margin-left: auto;
            display: flex;
            gap: 5px;
        }

        .search-box {
            width: 200px;
            height: 22px;
            padding: 3px 5px;
            border: 1px solid #DEDEE0;
            border-radius: 3px;
            font-size: 8pt;
        }

        /* Grid Toolbar */
        .grid-toolbar {
            background: #F0F0F0;
            height: 35px;
            padding: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #ddd;
        }

        /* Data Grid */
        .grid-container {
            flex: 1;
            overflow: auto;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
        }

        th {
            background: #F0F0F0;
            color: black;
            font-weight: bold;
            padding: 8px 5px;
            text-align: center;
            border-bottom: 2px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
        }

        th:hover {
            background: #E0E0E0;
        }

        td {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        tr {
            background: white;
        }

        tr:nth-child(even) {
            background: #FAFAFA;
        }

        tr:hover {
            background: #F5F5F5;
        }

        tr.selected {
            background: #0078D7 !important;
            color: white;
        }

        tr.selected:hover {
            background: #0066BB !important;
        }

        .number {
            text-align: right;
        }

        .center {
            text-align: center;
        }

        .status-active {
            color: green;
        }

        .status-completed {
            color: blue;
        }

        .status-printed {
            color: gray;
        }

        /* Status Bar */
        .status-bar {
            background: #F0F0F0;
            height: 30px;
            padding: 0 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid #ddd;
            font-size: 9pt;
        }

        .status-message {
            flex: 1;
        }

        .record-count {
            margin-left: auto;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 9pt;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #0078D7;
            font-size: 9pt;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 9pt;
        }

        .context-menu-item:hover {
            background: #F0F0F0;
        }

        /* PLC Heartbeat Monitor Component */
        .heartbeat-monitor {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .heartbeat-monitor-header {
            font-size: 11pt;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .heartbeat-monitor-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .heartbeat-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .heartbeat-field-label {
            font-size: 8pt;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .heartbeat-field-value {
            font-size: 10pt;
            color: #333;
            font-weight: 500;
        }

        .heartbeat-field-value.status-online {
            color: #28a745;
            font-weight: bold;
        }

        .heartbeat-field-value.status-waiting {
            color: #ffc107;
            font-weight: bold;
        }

        .heartbeat-field-value.status-offline {
            color: #dc3545;
            font-weight: bold;
        }

        .heartbeat-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        .status-dot.online {
            background-color: #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
        }

        .status-dot.waiting {
            background-color: #ffc107;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.6);
        }

        .status-dot.offline {
            background-color: #dc3545;
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
        }

        .heartbeat-placeholder {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 9pt;
            font-style: italic;
        }

        /* Test Print Section */
        .test-print-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .test-print-header {
            font-size: 11pt;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .test-print-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn-test-print {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 9pt;
            font-weight: bold;
            transition: background 0.2s;
        }

        .btn-test-print:hover {
            background: #218838;
        }

        .btn-test-print:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .test-print-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 9pt;
            display: none;
        }

        .test-print-result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }

        .test-print-result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }

        .test-print-result.loading {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            display: block;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-title">IIoT (PAS) - NDT Bundle Tag Printing</div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="header-heartbeat" id="headerHeartbeat">
                <span class="heartbeat-indicator heartbeat-disconnected" id="heartbeatIndicator"></span>
                <span class="heartbeat-status" id="heartbeatStatus">DISCONNECTED</span>
                <span class="heartbeat-value" id="heartbeatValue">(-)</span>
            </div>
        <div class="header-datetime" id="headerDateTime"></div>
        </div>
    </div>

    <!-- PLC Heartbeat Monitor -->
    <div class="heartbeat-monitor" id="heartbeatMonitor">
        <div class="heartbeat-monitor-header">PLC Heartbeat Monitor</div>
        <div class="heartbeat-placeholder" id="heartbeatPlaceholder">Waiting for data…</div>
        <div class="heartbeat-monitor-content" id="heartbeatContent" style="display: none;">
            <div class="heartbeat-field">
                <div class="heartbeat-field-label">PLC IP Address</div>
                <div class="heartbeat-field-value" id="heartbeatPlcIp">-</div>
            </div>
            <div class="heartbeat-field">
                <div class="heartbeat-field-label">Raw Heartbeat Value</div>
                <div class="heartbeat-field-value" id="heartbeatMonitorValue">-</div>
            </div>
            <div class="heartbeat-field">
                <div class="heartbeat-field-label">PLC Status</div>
                <div class="heartbeat-status-indicator">
                    <span class="status-dot offline" id="heartbeatStatusDot"></span>
                    <span class="heartbeat-field-value status-offline" id="heartbeatPlcStatus">-</span>
                </div>
            </div>
            <div class="heartbeat-field">
                <div class="heartbeat-field-label">Last Update Time</div>
                <div class="heartbeat-field-value" id="heartbeatLastUpdate">-</div>
            </div>
        </div>
    </div>

    <!-- Test Print Section -->
    <div class="test-print-section" id="testPrintSection">
        <div class="test-print-header">Test Printer</div>
        <div class="test-print-controls">
            <button class="btn-test-print" id="btnTestPrint" onclick="testPrint()">Test Print Label</button>
            <span style="font-size: 8pt; color: #666;">Prints a test label with dummy data to verify printer connection</span>
        </div>
        <div class="test-print-result" id="testPrintResult"></div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel">
        <!-- Row 1: Date Range -->
        <div class="filter-row">
            <label class="filter-label">From:</label>
            <input type="datetime-local" id="dtpFrom" class="filter-control large" value="">
            <label class="filter-label">To:</label>
            <input type="datetime-local" id="dtpTo" class="filter-control large" value="">
        </div>

        <!-- Row 2: PO and Pipe -->
        <div class="filter-row">
            <label class="filter-label">PO:</label>
            <input type="text" id="txtPO" class="filter-control medium" placeholder="Select PO" list="poList">
            <datalist id="poList"></datalist>
            <label class="filter-label">Pipe:</label>
            <input type="text" id="txtGrade" class="filter-control small" placeholder="Grade">
            <input type="text" id="txtSize" class="filter-control pipe" placeholder="Size">
            <input type="text" id="txtThick" class="filter-control small" placeholder="Thick">
            <input type="text" id="txtLength" class="filter-control small" placeholder="Length">
            <input type="text" id="txtType" class="filter-control small" placeholder="Type">
        </div>

        <!-- Row 3: HRC Batch and Slit No -->
        <div class="filter-row">
            <label class="filter-label">HRC Batch No:</label>
            <select id="cmbHRCBatch" class="filter-control" style="width: 175px;">
                <option value="">Select</option>
            </select>
            <label class="filter-label">Slit No:</label>
            <select id="cmbSlitNo" class="filter-control" style="width: 175px;">
                <option value="">Select</option>
            </select>
            <button class="btn btn-primary" onclick="applyFilters()">Filter</button>
        </div>

        <!-- Row 4: Shop/Line Buttons -->
        <div class="filter-row">
            <label class="filter-label">Shop/Line:</label>
            <button class="btn btn-shop" onclick="toggleShop(this, 'Mill1')">Mill 1</button>
            <button class="btn btn-shop" onclick="toggleShop(this, 'Mill2')">Mill 2</button>
            <button class="btn btn-shop" onclick="toggleShop(this, 'Mill3')">Mill 3</button>
            <button class="btn btn-shop" onclick="toggleShop(this, 'Common')">Common</button>
        </div>

        <!-- Row 5: Action Buttons and Search -->
        <div class="filter-row">
            <div class="filter-actions">
                <button class="btn btn-primary-bold" onclick="printSelectedBundles(false)">Print Bundles</button>
                <button class="btn btn-primary" onclick="showViewLog()">View Log</button>
                <input type="text" id="txtSearch" class="search-box" placeholder="Search bundles..." oninput="applyFilters()">
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <div class="content-area">
            <!-- Grid Toolbar -->
            <div class="grid-toolbar">
                <button class="btn btn-primary" onclick="exportToExcel()">Excel Export</button>
            </div>

            <!-- Data Grid -->
            <div class="grid-container" id="gridContainer">
                <div class="loading">Loading bundles...</div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-message" id="statusMessage">Ready</div>
            <div class="record-count" id="recordCount"></div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextPrint(false)">Print Selected</div>
        <div class="context-menu-item" onclick="contextPrint(true)">Reprint Selected</div>
        <div class="context-menu-item" onclick="viewDetails()">View Details</div>
        <div class="context-menu-item" onclick="exportToExcel()">Export to Excel</div>
    </div>

    <!-- SignalR library -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>

    <script>
        let allBundles = [];
        let filteredBundles = [];
        let selectedBundleIds = new Set();
        let activeShops = new Set();
        let heartbeatConnection = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Set default dates
            const now = new Date();
            const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
            document.getElementById('dtpFrom').value = formatDateForInput(oneMonthAgo);
            document.getElementById('dtpTo').value = formatDateForInput(now);
            
            loadBundles();
            initializeFilters();
            initializeHeartbeatConnection();
            
            // Also fetch initial heartbeat status
            fetchHeartbeatStatus();
        });

        // Initialize SignalR connection for heartbeat updates
        function initializeHeartbeatConnection() {
            heartbeatConnection = new signalR.HubConnectionBuilder()
                .withUrl("/heartbeathub")
                .withAutomaticReconnect()
                .build();

            heartbeatConnection.on("HeartbeatUpdate", function(data) {
                updateHeartbeatMonitor(data);
                // Also update header for backward compatibility
                updateHeartbeatDisplay(data.heartbeatValue, data.plcStatus);
            });

            heartbeatConnection.start()
                .then(function() {
                    console.log("Heartbeat SignalR connection established");
                })
                .catch(function(err) {
                    console.error("Error establishing heartbeat connection:", err);
                    // Fallback to polling
                    setInterval(fetchHeartbeatStatus, 1000);
                });

            heartbeatConnection.onreconnecting(function() {
                updateHeartbeatMonitor({
                    heartbeatValue: -1,
                    plcStatus: 'OFFLINE',
                    plcIp: '-',
                    lastUpdateTime: new Date().toISOString()
                });
                updateHeartbeatDisplay(-1, "RECONNECTING");
            });

            heartbeatConnection.onreconnected(function() {
                console.log("Heartbeat SignalR connection reconnected");
                fetchHeartbeatStatus();
            });
        }

        // Fetch heartbeat status via REST API (fallback)
        async function fetchHeartbeatStatus() {
            try {
                const response = await fetch('/api/plc/heartbeat');
                const data = await response.json();
                updateHeartbeatMonitor(data);
                // Also update header for backward compatibility
                updateHeartbeatDisplay(data.heartbeatValue, data.plcStatus);
            } catch (error) {
                console.error('Error fetching heartbeat status:', error);
                updateHeartbeatMonitor({
                    heartbeatValue: -1,
                    plcStatus: 'OFFLINE',
                    plcIp: '-',
                    lastUpdateTime: new Date().toISOString()
                });
                updateHeartbeatDisplay(-1, "ERROR");
            }
        }

        // Update PLC Heartbeat Monitor component
        function updateHeartbeatMonitor(data) {
            const placeholder = document.getElementById('heartbeatPlaceholder');
            const content = document.getElementById('heartbeatContent');
            const plcIpElement = document.getElementById('heartbeatPlcIp');
            const valueElement = document.getElementById('heartbeatMonitorValue');
            const statusElement = document.getElementById('heartbeatPlcStatus');
            const statusDot = document.getElementById('heartbeatStatusDot');
            const lastUpdateElement = document.getElementById('heartbeatLastUpdate');

            // Hide placeholder and show content when data arrives
            if (data && data.heartbeatValue !== undefined) {
                placeholder.style.display = 'none';
                content.style.display = 'grid';

                // Update PLC IP
                plcIpElement.textContent = data.plcIp || '-';

                // Update heartbeat value
                valueElement.textContent = data.heartbeatValue >= 0 ? data.heartbeatValue.toString() : '-';

                // Update status with color coding
                const status = data.plcStatus || 'OFFLINE';
                statusElement.textContent = status;

                // Remove all status classes
                statusDot.className = 'status-dot';
                statusElement.className = 'heartbeat-field-value';

                // Apply status-specific styling
                switch(status) {
                    case 'ONLINE':
                        statusDot.classList.add('online');
                        statusElement.classList.add('status-online');
                        break;
                    case 'WAITING':
                        statusDot.classList.add('waiting');
                        statusElement.classList.add('status-waiting');
                        break;
                    case 'OFFLINE':
                    default:
                        statusDot.classList.add('offline');
                        statusElement.classList.add('status-offline');
                        break;
                }

                // Update last update time
                if (data.lastUpdateTime) {
                    const updateTime = new Date(data.lastUpdateTime);
                    lastUpdateElement.textContent = formatDateTime(updateTime);
                } else {
                    lastUpdateElement.textContent = '-';
                }
            } else {
                // No data yet, show placeholder
                placeholder.style.display = 'block';
                content.style.display = 'none';
            }
        }

        // Test Print Function
        async function testPrint() {
            const btn = document.getElementById('btnTestPrint');
            const resultDiv = document.getElementById('testPrintResult');
            
            // Disable button and show loading
            btn.disabled = true;
            resultDiv.className = 'test-print-result loading';
            resultDiv.textContent = 'Printing test label...';
            resultDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/test-print', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'test-print-result success';
                    resultDiv.innerHTML = `
                        <strong>✓ Success!</strong><br>
                        ${data.message}<br>
                        <small style="margin-top: 5px; display: block;">
                            Bundle: ${data.printData?.bundleNo || 'N/A'} | 
                            PO: ${data.printData?.PO_No || 'N/A'} | 
                            Grade: ${data.printData?.Pipe_Grade || 'N/A'}
                        </small>
                    `;
                } else {
                    resultDiv.className = 'test-print-result error';
                    resultDiv.innerHTML = `
                        <strong>✗ Print Failed</strong><br>
                        ${data.message || 'Unknown error occurred'}
                    `;
                }
            } catch (error) {
                resultDiv.className = 'test-print-result error';
                resultDiv.innerHTML = `
                    <strong>✗ Error</strong><br>
                    Failed to connect to server: ${error.message}<br>
                    <small>Make sure the application is running and check the console for details.</small>
                `;
            } finally {
                // Re-enable button after 2 seconds
                setTimeout(() => {
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Update heartbeat display in header (backward compatibility)
        function updateHeartbeatDisplay(heartbeatValue, status) {
            const indicator = document.getElementById('heartbeatIndicator');
            const statusElement = document.getElementById('heartbeatStatus');
            const valueElement = document.getElementById('heartbeatValue');

            // Remove all status classes
            indicator.className = 'heartbeat-indicator';

            // Set status class and text
            switch(status) {
                case 'ONLINE':
                    indicator.classList.add('heartbeat-online');
                    statusElement.textContent = 'ONLINE';
                    valueElement.textContent = `(${heartbeatValue})`;
                    break;
                case 'WAITING':
                    indicator.classList.add('heartbeat-waiting');
                    statusElement.textContent = 'WAITING';
                    valueElement.textContent = `(${heartbeatValue})`;
                    break;
                case 'ERROR':
                case 'OFFLINE':
                    indicator.classList.add('heartbeat-error');
                    statusElement.textContent = status;
                    valueElement.textContent = heartbeatValue >= 0 ? `(${heartbeatValue})` : '(-)';
                    break;
                case 'DISCONNECTED':
                case 'RECONNECTING':
                    indicator.classList.add('heartbeat-disconnected');
                    statusElement.textContent = status;
                    valueElement.textContent = '(-)';
                    break;
                default:
                    indicator.classList.add('heartbeat-error');
                    statusElement.textContent = 'UNKNOWN';
                    valueElement.textContent = heartbeatValue >= 0 ? `(${heartbeatValue})` : '(-)';
            }
        }

        function updateDateTime() {
            const now = new Date();
            document.getElementById('headerDateTime').textContent = formatDateTime(now);
        }

        function formatDateTime(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const day = String(date.getDate()).padStart(2, '0');
            const month = months[date.getMonth()];
            const year = String(date.getFullYear()).substring(2);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
        }

        function formatDateForInput(date) {
            return date.toISOString().slice(0, 16);
        }

        async function loadBundles() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '<div class="loading">Loading bundles...</div>';

            try {
                const response = await fetch('/api/bundles');
                allBundles = await response.json();
                applyFilters();
                initializeFilters();
            } catch (error) {
                container.innerHTML = `<div class="no-data">Error loading bundles: ${error.message}</div>`;
                updateStatus('Error loading bundles');
            }
        }

        function initializeFilters() {
            // Populate PO list
            const poList = [...new Set(allBundles.map(b => {
                // Try to get PO_No from bundle data
                return b.po_No || 'N/A';
            }))].filter(po => po !== 'N/A');
            
            const datalist = document.getElementById('poList');
            datalist.innerHTML = '';
            poList.forEach(po => {
                const option = document.createElement('option');
                option.value = po;
                datalist.appendChild(option);
            });

            // Populate HRC Batch
            const batches = [...new Set(allBundles.map(b => b.batch_No).filter(b => b))];
            const cmbHRC = document.getElementById('cmbHRCBatch');
            cmbHRC.innerHTML = '<option value="">Select</option>';
            batches.forEach(batch => {
                const option = document.createElement('option');
                option.value = batch;
                option.textContent = batch;
                cmbHRC.appendChild(option);
            });

            // Populate Slit No
            const slits = [...new Set(allBundles.map(b => b.po_Plan_ID).filter(s => s))];
            const cmbSlit = document.getElementById('cmbSlitNo');
            cmbSlit.innerHTML = '<option value="">Select</option>';
            slits.forEach(slit => {
                const option = document.createElement('option');
                option.value = slit;
                option.textContent = slit;
                cmbSlit.appendChild(option);
            });
        }

        function applyFilters() {
            filteredBundles = [...allBundles];

            // Date filter
            const fromDate = new Date(document.getElementById('dtpFrom').value);
            const toDate = new Date(document.getElementById('dtpTo').value);
            filteredBundles = filteredBundles.filter(b => {
                const startTime = new Date(b.bundleStartTime);
                return startTime >= fromDate && startTime <= toDate;
            });

            // PO filter
            const poFilter = document.getElementById('txtPO').value;
            if (poFilter) {
                filteredBundles = filteredBundles.filter(b => {
                    const poNo = b.po_No || 'N/A';
                    return poNo.toLowerCase().includes(poFilter.toLowerCase());
                });
            }

            // Search filter
            const searchText = document.getElementById('txtSearch').value.toLowerCase();
            if (searchText) {
                filteredBundles = filteredBundles.filter(b => {
                    return (b.bundle_No || '').toLowerCase().includes(searchText) ||
                           (b.batch_No || '').toLowerCase().includes(searchText) ||
                           (b.po_No || 'N/A').toLowerCase().includes(searchText);
                });
            }

            renderGrid();
            updateStatusBar();
        }

        function renderGrid() {
            const container = document.getElementById('gridContainer');
            
            if (filteredBundles.length === 0) {
                container.innerHTML = '<div class="no-data">No bundles found. Adjust filters or add NDT cuts.</div>';
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th onclick="sortGrid(\'bundle_No\')">Bundle No.</th>';
            html += '<th onclick="sortGrid(\'batch_No\')">Batch No.</th>';
            html += '<th onclick="sortGrid(\'po_No\')">PO Number</th>';
            html += '<th onclick="sortGrid(\'ndt_Pcs\')" class="number">NDT Pcs</th>';
            html += '<th onclick="sortGrid(\'bundle_Wt\')" class="number">Bundle Wt (Tons)</th>';
            html += '<th onclick="sortGrid(\'status\')">Status</th>';
            html += '<th onclick="sortGrid(\'bundleStartTime\')" class="number">Bundle Start Time</th>';
            html += '<th onclick="sortGrid(\'bundleEndTime\')" class="number">Bundle End Time</th>';
            html += '<th onclick="sortGrid(\'oprDoneTime\')" class="number">Opr Done Time</th>';
            html += '<th onclick="sortGrid(\'isFullBundle\')" class="center">Is Full</th>';
            html += '<th onclick="sortGrid(\'po_Plan_ID\')" class="number">Slit No.</th>';
            html += '</tr></thead><tbody>';

            filteredBundles.forEach(bundle => {
                const status = bundle.status === 1 ? 'Active' : bundle.status === 2 ? 'Completed' : bundle.status === 3 ? 'Printed' : 'Unknown';
                const statusClass = bundle.status === 1 ? 'status-active' : bundle.status === 2 ? 'status-completed' : 'status-printed';
                const isSelected = selectedBundleIds.has(bundle.ndtBundle_ID);
                const rowClass = isSelected ? 'selected' : '';
                
                html += `<tr class="${rowClass}" onclick="toggleSelection(${bundle.ndtBundle_ID}, event)" oncontextmenu="showContextMenu(event, ${bundle.ndtBundle_ID})">`;
                html += `<td class="number">${bundle.bundle_No || ''}</td>`;
                html += `<td>${bundle.batch_No || ''}</td>`;
                html += `<td>${bundle.po_No || 'N/A'}</td>`;
                html += `<td class="number">${bundle.ndt_Pcs}</td>`;
                html += `<td class="number">${bundle.bundle_Wt.toFixed(2)}</td>`;
                html += `<td class="${statusClass}">${status}</td>`;
                html += `<td class="number">${formatDateTime(new Date(bundle.bundleStartTime))}</td>`;
                html += `<td class="number">${bundle.bundleEndTime ? formatDateTime(new Date(bundle.bundleEndTime)) : '-'}</td>`;
                html += `<td class="number">${bundle.oprDoneTime ? formatDateTime(new Date(bundle.oprDoneTime)) : '-'}</td>`;
                html += `<td class="center">${bundle.isFullBundle ? '✓' : ''}</td>`;
                html += `<td class="number">${bundle.po_Plan_ID || ''}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function toggleSelection(bundleId, event) {
            if (event.ctrlKey || event.metaKey) {
                // Multi-select with Ctrl/Cmd
                if (selectedBundleIds.has(bundleId)) {
                    selectedBundleIds.delete(bundleId);
                } else {
                    selectedBundleIds.add(bundleId);
                }
            } else {
                // Single select
                selectedBundleIds.clear();
                selectedBundleIds.add(bundleId);
            }
            renderGrid();
            updateStatusBar();
        }

        function showContextMenu(event, bundleId) {
            event.preventDefault();
            selectedBundleIds.clear();
            selectedBundleIds.add(bundleId);
            renderGrid();
            
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            
            document.addEventListener('click', function hideMenu() {
                menu.style.display = 'none';
                document.removeEventListener('click', hideMenu);
            });
        }

        function toggleShop(button, shopName) {
            if (activeShops.has(shopName)) {
                activeShops.delete(shopName);
                button.classList.remove('active');
            } else {
                activeShops.add(shopName);
                button.classList.add('active');
            }
            applyFilters();
        }

        function sortGrid(column) {
            filteredBundles.sort((a, b) => {
                const aVal = a[column];
                const bVal = b[column];
                if (aVal < bVal) return -1;
                if (aVal > bVal) return 1;
                return 0;
            });
            renderGrid();
        }

        function updateStatusBar() {
            const total = allBundles.length;
            const filtered = filteredBundles.length;
            const selected = selectedBundleIds.size;
            document.getElementById('recordCount').textContent = `Total: ${total} | Filtered: ${filtered} | Selected: ${selected}`;
        }

        function updateStatus(message) {
            document.getElementById('statusMessage').textContent = message;
        }

        async function printSelectedBundles(isReprint) {
            if (selectedBundleIds.size === 0) {
                alert('Please select at least one bundle to print.');
                return;
            }

            const bundleIds = Array.from(selectedBundleIds);
            let successCount = 0;

            for (const bundleId of bundleIds) {
                try {
                    const response = await fetch(`/api/print/${bundleId}`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    }
                } catch (error) {
                    console.error('Print error:', error);
                }
            }

            updateStatus(`Printed ${successCount} of ${bundleIds.length} bundles`);
            loadBundles();
        }

        function contextPrint(isReprint) {
            printSelectedBundles(isReprint);
        }

        function viewDetails() {
            if (selectedBundleIds.size === 0) return;
            const bundleId = Array.from(selectedBundleIds)[0];
            const bundle = allBundles.find(b => b.ndtBundle_ID === bundleId);
            if (bundle) {
                alert(`Bundle Details:\n\nBundle No: ${bundle.bundle_No}\nBatch No: ${bundle.batch_No}\nNDT Pieces: ${bundle.ndt_Pcs}\nBundle Weight: ${bundle.bundle_Wt} Tons\nStatus: ${bundle.status === 1 ? 'Active' : bundle.status === 2 ? 'Completed' : 'Printed'}`);
            }
        }

        function exportToExcel() {
            // Create CSV content
            let csv = 'Bundle No,Batch No,PO Number,NDT Pcs,Bundle Wt (Tons),Status,Bundle Start Time,Bundle End Time,Opr Done Time,Is Full,Slit No\n';
            
            filteredBundles.forEach(bundle => {
                const status = bundle.status === 1 ? 'Active' : bundle.status === 2 ? 'Completed' : 'Printed';
                csv += `${bundle.bundle_No || ''},${bundle.batch_No || ''},${bundle.po_No || 'N/A'},${bundle.ndt_Pcs},${bundle.bundle_Wt.toFixed(2)},${status},${formatDateTime(new Date(bundle.bundleStartTime))},${bundle.bundleEndTime ? formatDateTime(new Date(bundle.bundleEndTime)) : '-'},${bundle.oprDoneTime ? formatDateTime(new Date(bundle.oprDoneTime)) : '-'},${bundle.isFullBundle ? 'Yes' : 'No'},${bundle.po_Plan_ID || ''}\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `NDTBundleDetails_${new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            updateStatus('Excel export completed');
        }

        function showViewLog() {
            alert('View Log functionality not implemented');
        }
    </script>
</body>
</html>
