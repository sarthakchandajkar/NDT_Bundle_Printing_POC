<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIoT (PAS) - NDT Bundle Tag Printing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: white;
            min-height: 100vh;
            font-size: 9pt;
            overflow-y: auto;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        /* Header */
        .header {
            background: #F0F0F0;
            height: 40px;
            padding: 0 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #ddd;
        }

        .header-title {
            font-size: 10pt;
            font-weight: bold;
            color: black;
        }

        .header-datetime {
            font-size: 9pt;
            color: black;
        }

        .header-heartbeat {
            font-size: 9pt;
            margin-right: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .heartbeat-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .heartbeat-online {
            background-color: #28a745;
            box-shadow: 0 0 5px #28a745;
        }

        .heartbeat-waiting {
            background-color: #ffc107;
            box-shadow: 0 0 5px #ffc107;
        }

        .heartbeat-error {
            background-color: #dc3545;
            box-shadow: 0 0 5px #dc3545;
        }

        .heartbeat-disconnected {
            background-color: #6c757d;
        }

        .heartbeat-status {
            font-weight: bold;
        }

        .heartbeat-value {
            font-family: monospace;
            color: #666;
        }

        /* Filter Panel */
        .filter-panel {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            min-height: 220px;
            overflow-y: auto;
            overflow-x: visible;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .filter-label {
            width: 50px;
            font-size: 9pt;
        }

        .filter-control {
            padding: 3px 5px;
            border: 1px solid #DEDEE0;
            border-radius: 3px;
            font-size: 8pt;
            height: 20px;
        }

        .filter-control.large {
            width: 180px;
        }

        .filter-control.medium {
            width: 150px;
        }

        .filter-control.small {
            width: 60px;
        }

        .filter-control.pipe {
            width: 90px;
        }

        .btn {
            padding: 3px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 8pt;
            height: 22px;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #0078D7;
            color: white;
        }

        .btn-primary:hover {
            background: #0066BB;
        }

        .btn-primary-bold {
            background: #0078D7;
            color: white;
            font-weight: bold;
        }

        .btn-orange {
            background: #FF8C00;
            color: white;
        }

        .btn-orange:hover {
            background: #E67A00;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-shop {
            width: 80px;
            height: 22px;
            background: #F0F0F0;
            color: black;
            border: 1px solid #ddd;
        }

        .btn-shop.active {
            background: #3BB9FF;
            color: black;
        }

        .filter-actions {
            margin-left: auto;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            width: 200px;
            height: 22px;
            padding: 3px 5px;
            border: 1px solid #DEDEE0;
            border-radius: 3px;
            font-size: 8pt;
        }

        /* Grid Toolbar */
        .grid-toolbar {
            background: #F0F0F0;
            height: 35px;
            padding: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #ddd;
        }

        /* Data Grid - Moved to main layout section for better scrolling control */

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
        }

        th {
            background: #F0F0F0;
            color: black;
            font-weight: bold;
            padding: 8px 5px;
            text-align: center;
            border-bottom: 2px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
        }

        th:hover {
            background: #E0E0E0;
        }

        td {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        tr {
            background: white;
        }

        tr:nth-child(even) {
            background: #FAFAFA;
        }

        tr:hover {
            background: #F5F5F5;
        }

        tr.selected {
            background: #0078D7 !important;
            color: white;
        }

        tr.selected:hover {
            background: #0066BB !important;
        }

        .number {
            text-align: right;
        }

        .center {
            text-align: center;
        }

        .status-active {
            color: green;
        }

        .status-completed {
            color: blue;
        }

        .status-printed {
            color: gray;
        }

        /* Status Bar */
        .status-bar {
            background: #F0F0F0;
            height: 30px;
            padding: 0 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid #ddd;
            font-size: 9pt;
        }

        .status-message {
            flex: 1;
        }

        .record-count {
            margin-left: auto;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex-direction: column;
            min-height: 400px; /* Minimum height for content area */
            margin: 10px;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0; /* Allow flex item to shrink */
        }
        
        /* Ensure grid container can scroll */
        .grid-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            background: white;
            min-height: 200px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 9pt;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #0078D7;
            font-size: 9pt;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 9pt;
        }

        .context-menu-item:hover {
            background: #F0F0F0;
        }

        /* Test Print Section */
        .test-print-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .test-print-header {
            font-size: 11pt;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .test-print-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn-test-print {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 9pt;
            font-weight: bold;
            transition: background 0.2s;
        }

        .btn-test-print:hover {
            background: #218838;
        }

        .btn-test-print:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .test-print-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 9pt;
            display: none;
        }

        .test-print-result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }

        .test-print-result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }

        .test-print-result.loading {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 1200px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 4px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .modal-title {
            font-size: 14pt;
            font-weight: bold;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
        }

        .modal-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .modal-table th,
        .modal-table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .modal-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        .modal-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .modal-form {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .modal-form label {
            font-weight: bold;
        }

        .modal-form input,
        .modal-form select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Status Dot (used in System Monitor) */
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        .status-dot.online {
            background-color: #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
        }

        .status-dot.waiting {
            background-color: #ffc107;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.6);
        }

        .status-dot.offline {
            background-color: #dc3545;
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
        }

        /* System Monitor Section */
        .system-monitor {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .system-monitor-header {
            font-size: 11pt;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .system-monitor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .monitor-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
        }

        .monitor-card-header {
            font-size: 9pt;
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .monitor-card-content {
            font-size: 9pt;
        }

        .monitor-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .monitor-value {
            font-size: 11pt;
            font-weight: bold;
            color: #333;
        }

        .monitor-label {
            font-size: 8pt;
            color: #666;
            margin-top: 4px;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 8pt;
            font-weight: bold;
        }

        .status-badge.connected {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.testing {
            background: #fff3cd;
            color: #856404;
        }

        .activity-log {
            max-height: 150px;
            overflow-y: auto;
            font-size: 8pt;
            font-family: monospace;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .activity-log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .activity-log-entry:last-child {
            border-bottom: none;
        }

        .activity-log-time {
            color: #6c757d;
            margin-right: 8px;
        }

        .refresh-btn {
            background: #0078D7;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 8pt;
            height: 24px;
        }

        .refresh-btn:hover {
            background: #0066BB;
        }

        /* Pipe Counting Activity Section */
        .pipe-counting-activity {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pipe-counting-activity-header {
            font-size: 11pt;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pipe-activity-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8pt;
            margin-top: 10px;
        }

        .pipe-activity-table th {
            background: #f8f9fa;
            padding: 6px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .pipe-activity-table td {
            padding: 4px 6px;
            border-bottom: 1px solid #eee;
        }

        .pipe-activity-table tr:hover {
            background: #f5f5f5;
        }

        .pipe-type-ok {
            color: #28a745;
            font-weight: bold;
        }

        .pipe-type-ndt {
            color: #dc3545;
            font-weight: bold;
        }

        .pipe-activity-scroll {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-title">IIoT (PAS) - NDT Bundle Tag Printing</div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="header-heartbeat" id="headerHeartbeat">
                <span class="heartbeat-indicator heartbeat-disconnected" id="heartbeatIndicator"></span>
                <span class="heartbeat-status" id="heartbeatStatus">DISCONNECTED</span>
                <span class="heartbeat-value" id="heartbeatValue">(-)</span>
            </div>
        <div class="header-datetime" id="headerDateTime"></div>
        </div>
    </div>

    <!-- System Monitor Section -->
    <div class="system-monitor" id="systemMonitor">
        <div class="system-monitor-header">
            <span>System Status Monitor</span>
            <button class="refresh-btn" onclick="refreshSystemStatus()">Refresh</button>
        </div>
        <div class="system-monitor-grid">
            <!-- PLC Status Card -->
            <div class="monitor-card">
                <div class="monitor-card-header">
                    <span class="status-dot offline" id="plcStatusDot"></span>
                    <span>PLC Connection</span>
                </div>
                <div class="monitor-card-content">
                    <div class="monitor-status">
                        <span class="monitor-value" id="plcConnectionStatus">Checking...</span>
                    </div>
                    <div class="monitor-label">IP: <span id="plcIpAddress">192.168.0.13</span></div>
                    <div class="monitor-label">Rack: 0, Slot: 2 (S7-300)</div>
                </div>
            </div>

            <!-- Printer Status Card -->
            <div class="monitor-card">
                <div class="monitor-card-header">
                    <span class="status-dot offline" id="printerStatusDot"></span>
                    <span>Printer Connection</span>
                </div>
                <div class="monitor-card-content">
                    <div class="monitor-status">
                        <span class="monitor-value" id="printerConnectionStatus">Checking...</span>
                    </div>
                    <div class="monitor-label">IP: <span id="printerIpAddress">192.168.0.125</span></div>
                    <div class="monitor-label">Port: 9100 (ZPL)</div>
                </div>
            </div>

            <!-- Current Pipe Counts Card -->
            <div class="monitor-card">
                <div class="monitor-card-header">
                    <span>Current Pipe Counts (PLC)</span>
                </div>
                <div class="monitor-card-content">
                    <div class="monitor-status">
                        <span class="monitor-label">OK Pipes:</span>
                        <span class="monitor-value" id="currentOKCount" style="color: #28a745;">0</span>
                    </div>
                    <div class="monitor-status">
                        <span class="monitor-label">NDT Pipes:</span>
                        <span class="monitor-value" id="currentNDTCount" style="color: #dc3545;">0</span>
                    </div>
                    <div class="monitor-label">Read from DB251.DBW2 (OK) and DB251.DBW6 (NDT)</div>
                </div>
            </div>

            <!-- NDT Counts Card -->
            <div class="monitor-card">
                <div class="monitor-card-header">
                    <span>NDT Bundle Statistics</span>
                </div>
                <div class="monitor-card-content">
                    <div class="monitor-status">
                        <span class="monitor-label">Total in Bundles:</span>
                        <span class="monitor-value" id="totalNDTInBundles">0</span>
                    </div>
                    <div class="monitor-status">
                        <span class="monitor-label">Bundles Created:</span>
                        <span class="monitor-value" id="bundlesCreated">0</span>
                    </div>
                    <div class="monitor-status">
                        <span class="monitor-label">Tags Printed:</span>
                        <span class="monitor-value" id="tagsPrinted">0</span>
                    </div>
                    <div class="monitor-label">Threshold: 5 pipes per bundle</div>
                </div>
            </div>

            <!-- OK Bundle Statistics Card -->
            <div class="monitor-card">
                <div class="monitor-card-header">
                    <span>OK Bundle Statistics</span>
                </div>
                <div class="monitor-card-content">
                    <div class="monitor-status">
                        <span class="monitor-label">Total in Bundles:</span>
                        <span class="monitor-value" id="totalOKInBundles">0</span>
                    </div>
                    <div class="monitor-status">
                        <span class="monitor-label">Bundles Created:</span>
                        <span class="monitor-value" id="okBundlesCreated">0</span>
                    </div>
                    <div class="monitor-status">
                        <span class="monitor-label">Tags Printed:</span>
                        <span class="monitor-value" id="okTagsPrinted">0</span>
                    </div>
                    <div class="monitor-label">Threshold: 5 pipes per bundle</div>
                </div>
            </div>

            <!-- Bundle Status Card -->
            <div class="monitor-card">
                <div class="monitor-card-header">
                    <span>Bundle Status</span>
                </div>
                <div class="monitor-card-content">
                    <div class="monitor-status">
                        <span class="monitor-label">Active:</span>
                        <span class="monitor-value" id="activeBundles">0</span>
                    </div>
                    <div class="monitor-status">
                        <span class="monitor-label">Ready to Print:</span>
                        <span class="monitor-value" id="readyBundles">0</span>
                    </div>
                    <div class="monitor-status">
                        <span class="monitor-label">Printed:</span>
                        <span class="monitor-value" id="printedBundles">0</span>
                    </div>
                </div>
            </div>

            <!-- Test Scenario Tag Count Card -->
            <div class="monitor-card" id="testScenarioTagCard" style="display: none; border: 2px solid #ffc107;">
                <div class="monitor-card-header" style="background: #fff3cd; padding: 8px; border-radius: 4px;">
                    <span style="color: #856404; font-weight: bold;">Test Scenario: Tag Verification</span>
                </div>
                <div class="monitor-card-content">
                    <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                        <div style="font-size: 8pt; color: #666; margin-bottom: 5px;">Active Scenario:</div>
                        <div style="font-size: 10pt; font-weight: bold; color: #0078D7;" id="monitorActiveScenario">None</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="padding: 8px; background: #e7f3ff; border-radius: 4px;">
                            <div style="font-size: 8pt; color: #666; margin-bottom: 5px;">OK Bundle Tags</div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="font-size: 9pt;">Expected:</span>
                                <span id="monitorExpectedOK" style="font-size: 12pt; font-weight: bold; color: #0078D7;">-</span>
                                <span style="font-size: 9pt;">|</span>
                                <span style="font-size: 9pt;">Actual:</span>
                                <span id="monitorActualOK" style="font-size: 12pt; font-weight: bold; color: #28a745;">0</span>
                                <span id="monitorOKMatch" style="font-size: 14pt;"></span>
                            </div>
                        </div>
                        <div style="padding: 8px; background: #ffe7e7; border-radius: 4px;">
                            <div style="font-size: 8pt; color: #666; margin-bottom: 5px;">NDT Bundle Tags</div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="font-size: 9pt;">Expected:</span>
                                <span id="monitorExpectedNDT" style="font-size: 12pt; font-weight: bold; color: #0078D7;">-</span>
                                <span style="font-size: 9pt;">|</span>
                                <span style="font-size: 9pt;">Actual:</span>
                                <span id="monitorActualNDT" style="font-size: 12pt; font-weight: bold; color: #dc3545;">0</span>
                                <span id="monitorNDTMatch" style="font-size: 14pt;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-top: 15px;">
            <div class="monitor-card-header">Recent Activity</div>
            <div class="activity-log" id="activityLog">
                <div class="activity-log-entry">Waiting for activity...</div>
            </div>
        </div>
    </div>

    <!-- Pipe Counting Activity Section -->
    <div class="pipe-counting-activity" id="pipeCountingActivity">
        <div class="pipe-counting-activity-header">
            <span>Pipe Counting Activity (Real-time)</span>
            <button class="refresh-btn" onclick="refreshPipeActivity()">Refresh</button>
        </div>
        <div class="pipe-activity-scroll">
            <table class="pipe-activity-table" id="pipeActivityTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Count</th>
                        <th>Total OK</th>
                        <th>Total NDT</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody id="pipeActivityBody">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #999; padding: 20px;">
                            Waiting for pipe counting activity...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Test Print Section -->
    <div class="test-print-section" id="testPrintSection">
        <div class="test-print-header">Test Printer</div>
        <div class="test-print-controls">
            <button class="btn-test-print" id="btnTestPrint" onclick="testPrint()">Test Print Label</button>
            <span style="font-size: 8pt; color: #666;">Prints a test label with dummy data to verify printer connection</span>
        </div>
        <div class="test-print-result" id="testPrintResult"></div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel">
        <!-- Action Buttons Row (Moved to top for visibility) -->
        <div class="filter-row" style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #0078D7; background: #f8f9fa;">
            <div class="filter-actions" style="width: 100%; justify-content: flex-start; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="openPOPlanManagement()" style="min-width: 140px; font-weight: bold;">Manage PO Plans</button>
                <button class="btn btn-orange" onclick="openTestScenarioManager()" style="min-width: 160px; font-weight: bold;">Test Scenarios</button>
                <button class="btn btn-success" id="btnPLCPolling" onclick="togglePLCPolling()" style="min-width: 140px; font-weight: bold;">Start PLC Polling</button>
                <button class="btn btn-primary-bold" onclick="printSelectedBundles(false)">Print Bundles</button>
                <button class="btn btn-primary" onclick="showViewLog()">View Log</button>
                <input type="text" id="txtSearch" class="search-box" placeholder="Search bundles..." oninput="applyFilters()" style="margin-left: auto;">
            </div>
        </div>

        <!-- Row 1: Date Range -->
        <div class="filter-row">
            <label class="filter-label">From:</label>
            <input type="datetime-local" id="dtpFrom" class="filter-control large" value="">
            <label class="filter-label">To:</label>
            <input type="datetime-local" id="dtpTo" class="filter-control large" value="">
        </div>

        <!-- Row 2: PO and Pipe -->
        <div class="filter-row">
            <label class="filter-label">PO:</label>
            <input type="text" id="txtPO" class="filter-control medium" placeholder="Select PO" list="poList">
            <datalist id="poList"></datalist>
            <label class="filter-label">Pipe:</label>
            <input type="text" id="txtGrade" class="filter-control small" placeholder="Grade">
            <input type="text" id="txtSize" class="filter-control pipe" placeholder="Size">
            <input type="text" id="txtThick" class="filter-control small" placeholder="Thick">
            <input type="text" id="txtLength" class="filter-control small" placeholder="Length">
            <input type="text" id="txtType" class="filter-control small" placeholder="Type">
        </div>

        <!-- Row 3: HRC Batch and Slit No -->
        <div class="filter-row">
            <label class="filter-label">HRC Batch No:</label>
            <select id="cmbHRCBatch" class="filter-control" style="width: 175px;">
                <option value="">Select</option>
            </select>
            <label class="filter-label">Slit No:</label>
            <select id="cmbSlitNo" class="filter-control" style="width: 175px;">
                <option value="">Select</option>
            </select>
            <button class="btn btn-primary" onclick="applyFilters()">Filter</button>
        </div>

        <!-- Row 4: Shop/Line Buttons -->
        <div class="filter-row">
            <label class="filter-label">Shop/Line:</label>
            <button class="btn btn-shop" onclick="toggleShop(this, 'Mill1')">Mill 1</button>
            <button class="btn btn-shop" onclick="toggleShop(this, 'Mill2')">Mill 2</button>
            <button class="btn btn-shop" onclick="toggleShop(this, 'Mill3')">Mill 3</button>
            <button class="btn btn-shop" onclick="toggleShop(this, 'Common')">Common</button>
        </div>

    </div>

    <!-- Main Content -->
    <div class="main-container">
        <div class="content-area">
            <!-- Grid Toolbar -->
            <div class="grid-toolbar">
                <button class="btn btn-primary" onclick="exportToExcel()">Excel Export</button>
            </div>

            <!-- Data Grid -->
            <div class="grid-container" id="gridContainer">
                <div class="loading">Loading bundles...</div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-message" id="statusMessage">Ready</div>
            <div class="record-count" id="recordCount"></div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextPrint(false)">Print Selected</div>
        <div class="context-menu-item" onclick="contextPrint(true)">Reprint Selected</div>
        <div class="context-menu-item" onclick="viewDetails()">View Details</div>
        <div class="context-menu-item" onclick="exportToExcel()">Export to Excel</div>
    </div>

    <!-- PO Plan Management Modal -->
    <div id="poPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">PO Plan Management</h2>
                <span class="close" onclick="closePOPlanModal()">&times;</span>
            </div>
            <div>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="openPOPlanEditDialog(null)">Add New PO Plan</button>
                    <button class="btn btn-primary" onclick="refreshPOPlans()" style="margin-left: 10px;">Refresh</button>
                    <input type="text" id="poPlanSearch" class="search-box" placeholder="Search PO Plans..." 
                           style="margin-left: 10px; width: 250px;" oninput="filterPOPlans()">
                </div>
                <table class="modal-table" id="poPlanTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>PLC PO ID</th>
                            <th>PO Number</th>
                            <th>Pipe Type</th>
                            <th>Pipe Size</th>
                            <th>Pcs Per Bundle</th>
                            <th>Pipe Length</th>
                            <th>Pipe Wt/mtr</th>
                            <th>SAP Type</th>
                            <th>Shop ID</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="poPlanTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Test Scenario Manager Modal -->
    <div id="testScenarioModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">Test Scenario Manager</h2>
                <span class="close" onclick="closeTestScenarioModal()">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <div style="background: #e7f3ff; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #0078D7;">
                    <strong style="color: #0078D7;">Current Active Scenario:</strong> 
                    <span id="currentActiveScenario" style="color: #28a745; font-weight: bold; margin-left: 10px;">None</span>
                </div>
                
                <!-- Tag Count Summary for Active Scenario -->
                <div id="tagCountSummary" style="display: none; background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 11pt; font-weight: bold; color: #856404;">Tag Printing Summary (Current Scenario)</div>
                        <button class="btn btn-primary" onclick="refreshTagCounts()" style="padding: 4px 10px; font-size: 8pt; height: 24px;">Refresh Counts</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 10pt; font-weight: bold; color: #333; margin-bottom: 8px;">OK Bundle Tags</div>
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <span style="font-size: 9pt; color: #666;">Expected:</span>
                                <span id="expectedOKTags" style="font-size: 14pt; font-weight: bold; color: #0078D7; min-width: 30px; text-align: center;">-</span>
                                <span style="font-size: 9pt; color: #666;">|</span>
                                <span style="font-size: 9pt; color: #666;">Actual:</span>
                                <span id="actualOKTags" style="font-size: 14pt; font-weight: bold; color: #28a745; min-width: 30px; text-align: center;">0</span>
                                <span id="okTagsMatch" style="font-size: 16pt; margin-left: 5px; min-width: 20px;"></span>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 10pt; font-weight: bold; color: #333; margin-bottom: 8px;">NDT Bundle Tags</div>
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <span style="font-size: 9pt; color: #666;">Expected:</span>
                                <span id="expectedNDTTags" style="font-size: 14pt; font-weight: bold; color: #0078D7; min-width: 30px; text-align: center;">-</span>
                                <span style="font-size: 9pt; color: #666;">|</span>
                                <span style="font-size: 9pt; color: #666;">Actual:</span>
                                <span id="actualNDTTags" style="font-size: 14pt; font-weight: bold; color: #dc3545; min-width: 30px; text-align: center;">0</span>
                                <span id="ndtTagsMatch" style="font-size: 16pt; margin-left: 5px; min-width: 20px;"></span>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 8pt; color: #666; font-style: italic;">
                        * Actual counts update automatically every 5 seconds. Click "Refresh Counts" for immediate update.
                    </div>
                </div>
                
                <div style="font-size: 9pt; color: #666; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <strong>Test Data:</strong> OK Pipes = 42, NDT Pipes = 30<br>
                    Select a test scenario to activate. This will automatically create/activate the PO Plan and Slit for testing.
                    The current active PO will be closed and the selected scenario will become active.
                </div>
            </div>
            <table class="modal-table">
                <thead>
                    <tr>
                        <th>Scenario</th>
                        <th>Pipe Size</th>
                        <th>OK Pcs/Bundle</th>
                        <th>NDT Pcs/Bundle</th>
                        <th>Expected OK Tags</th>
                        <th>Expected NDT Tags</th>
                        <th>Expected OK Bundles</th>
                        <th>Expected NDT Bundles</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="testScenarioTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- PO Plan Edit Modal -->
    <div id="poPlanEditModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="poPlanEditTitle">Add PO Plan</h2>
                <span class="close" onclick="closePOPlanEditModal()">&times;</span>
            </div>
            <form id="poPlanEditForm" class="modal-form">
                <label>PLC PO ID:</label>
                <input type="number" id="editPLC_POID" />

                <label>PO Number *:</label>
                <input type="text" id="editPO_No" required />

                <label>Pipe Type:</label>
                <input type="text" id="editPipe_Type" />

                <label>Pipe Size:</label>
                <input type="text" id="editPipe_Size" />

                <label>Pcs Per Bundle:</label>
                <input type="number" id="editPcsPerBundle" value="0" min="0" />

                <label>Pipe Length:</label>
                <input type="number" id="editPipe_Len" value="0" step="0.01" min="0" />

                <label>Pipe Wt/mtr:</label>
                <input type="number" id="editPipeWt_per_mtr" value="0" step="0.01" min="0" />

                <label>SAP Type:</label>
                <input type="text" id="editSAP_Type" />

                <label>Shop ID:</label>
                <input type="number" id="editShop_ID" value="0" min="0" />
            </form>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="savePOPlan()">Save</button>
                <button class="btn btn-secondary" onclick="closePOPlanEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- SignalR library -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>

    <script>
        let allBundles = [];
        let filteredBundles = [];
        let selectedBundleIds = new Set();
        let activeShops = new Set();
        let heartbeatConnection = null;
        let systemStatusInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Set default dates
            const now = new Date();
            const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
            document.getElementById('dtpFrom').value = formatDateForInput(oneMonthAgo);
            document.getElementById('dtpTo').value = formatDateForInput(now);
            
            loadBundles();
            initializeFilters();
            initializeHeartbeatConnection();
            
            // Also fetch initial heartbeat status
            fetchHeartbeatStatus();
            
            // Check initial polling status
            checkPollingStatus();
            setInterval(checkPollingStatus, 5000); // Check every 5 seconds
            
            // Initialize system status monitoring
            refreshSystemStatus();
            refreshPipeActivity();
            systemStatusInterval = setInterval(() => {
                refreshSystemStatus();
                refreshPipeActivity();
            }, 2000); // Refresh every 2 seconds
            
            // Check active scenario on page load and periodically
            checkActiveScenario();
            setInterval(checkActiveScenario, 5000);
        });

        // Initialize SignalR connection for heartbeat updates
        function initializeHeartbeatConnection() {
            heartbeatConnection = new signalR.HubConnectionBuilder()
                .withUrl("/heartbeathub")
                .withAutomaticReconnect()
                .build();

            heartbeatConnection.on("HeartbeatUpdate", function(data) {
                // Update header heartbeat display
                updateHeartbeatDisplay(data.heartbeatValue, data.plcStatus);
            });

            heartbeatConnection.start()
                .then(function() {
                    console.log("Heartbeat SignalR connection established");
                })
                .catch(function(err) {
                    console.error("Error establishing heartbeat connection:", err);
                    // Fallback to polling
                    setInterval(fetchHeartbeatStatus, 1000);
                });

            heartbeatConnection.onreconnecting(function() {
                updateHeartbeatDisplay(-1, "RECONNECTING");
            });

            heartbeatConnection.onreconnected(function() {
                console.log("Heartbeat SignalR connection reconnected");
                fetchHeartbeatStatus();
            });
        }

        // Fetch heartbeat status via REST API (fallback)
        async function fetchHeartbeatStatus() {
            try {
                const response = await fetch('/api/plc/heartbeat');
                const data = await response.json();
                // Update header heartbeat display
                updateHeartbeatDisplay(data.heartbeatValue, data.plcStatus);
            } catch (error) {
                console.error('Error fetching heartbeat status:', error);
                updateHeartbeatDisplay(-1, "ERROR");
            }
        }

        // Test Print Function
        async function testPrint() {
            const btn = document.getElementById('btnTestPrint');
            const resultDiv = document.getElementById('testPrintResult');
            const statusDot = document.getElementById('printerStatusDot');
            const statusText = document.getElementById('printerConnectionStatus');
            
            // Disable button and show loading
            btn.disabled = true;
            resultDiv.className = 'test-print-result loading';
            resultDiv.textContent = 'Testing printer connection...';
            resultDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/test-print', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'test-print-result success';
                    resultDiv.innerHTML = `
                        <strong>✓ Success!</strong><br>
                        ${data.message}<br>
                        <small style="margin-top: 5px; display: block;">
                            Bundle: ${data.printData?.bundleNo || 'N/A'} | 
                            PO: ${data.printData?.PO_No || 'N/A'} | 
                            Grade: ${data.printData?.Pipe_Grade || 'N/A'}
                        </small>
                    `;
                    statusDot.className = 'status-dot online';
                    statusText.textContent = 'CONNECTED';
                    statusText.style.color = '#28a745';
                    addActivityLog('Printer test successful - label printed');
                } else {
                    resultDiv.className = 'test-print-result error';
                    resultDiv.innerHTML = `
                        <strong>✗ Print Failed</strong><br>
                        ${data.message || 'Unknown error occurred'}
                    `;
                    statusDot.className = 'status-dot offline';
                    statusText.textContent = 'ERROR';
                    statusText.style.color = '#dc3545';
                    addActivityLog('Printer test failed - check connection');
                }
            } catch (error) {
                resultDiv.className = 'test-print-result error';
                resultDiv.innerHTML = `
                    <strong>✗ Error</strong><br>
                    Failed to connect to server: ${error.message}<br>
                    <small>Make sure the application is running and check the console for details.</small>
                `;
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'ERROR';
                statusText.style.color = '#dc3545';
                addActivityLog('Printer test error: ' + error.message);
            } finally {
                // Re-enable button after 2 seconds
                setTimeout(() => {
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Update heartbeat display in header (backward compatibility)
        function updateHeartbeatDisplay(heartbeatValue, status) {
            const indicator = document.getElementById('heartbeatIndicator');
            const statusElement = document.getElementById('heartbeatStatus');
            const valueElement = document.getElementById('heartbeatValue');

            // Remove all status classes
            indicator.className = 'heartbeat-indicator';

            // Set status class and text
            switch(status) {
                case 'ONLINE':
                    indicator.classList.add('heartbeat-online');
                    statusElement.textContent = 'ONLINE';
                    valueElement.textContent = `(${heartbeatValue})`;
                    break;
                case 'WAITING':
                    indicator.classList.add('heartbeat-waiting');
                    statusElement.textContent = 'WAITING';
                    valueElement.textContent = `(${heartbeatValue})`;
                    break;
                case 'ERROR':
                case 'OFFLINE':
                    indicator.classList.add('heartbeat-error');
                    statusElement.textContent = status;
                    valueElement.textContent = heartbeatValue >= 0 ? `(${heartbeatValue})` : '(-)';
                    break;
                case 'DISCONNECTED':
                case 'RECONNECTING':
                    indicator.classList.add('heartbeat-disconnected');
                    statusElement.textContent = status;
                    valueElement.textContent = '(-)';
                    break;
                default:
                    indicator.classList.add('heartbeat-error');
                    statusElement.textContent = 'UNKNOWN';
                    valueElement.textContent = heartbeatValue >= 0 ? `(${heartbeatValue})` : '(-)';
            }
        }

        function updateDateTime() {
            const now = new Date();
            document.getElementById('headerDateTime').textContent = formatDateTime(now);
        }

        function formatDateTime(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const day = String(date.getDate()).padStart(2, '0');
            const month = months[date.getMonth()];
            const year = String(date.getFullYear()).substring(2);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
        }

        function formatDateForInput(date) {
            return date.toISOString().slice(0, 16);
        }

        async function loadBundles() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '<div class="loading">Loading bundles...</div>';

            try {
                const response = await fetch('/api/bundles');
                const previousCount = allBundles.length;
                allBundles = await response.json();
                
                if (allBundles.length > previousCount) {
                    const newCount = allBundles.length - previousCount;
                    addActivityLog(`Loaded ${allBundles.length} bundles (${newCount} new)`);
                }
                
                applyFilters();
                initializeFilters();
                updateBundleStatus();
            } catch (error) {
                container.innerHTML = `<div class="no-data">Error loading bundles: ${error.message}</div>`;
                updateStatus('Error loading bundles');
                addActivityLog('Error loading bundles: ' + error.message);
            }
        }

        function initializeFilters() {
            // Populate PO list
            const poList = [...new Set(allBundles.map(b => {
                // Try to get PO_No from bundle data
                return b.po_No || 'N/A';
            }))].filter(po => po !== 'N/A');
            
            const datalist = document.getElementById('poList');
            datalist.innerHTML = '';
            poList.forEach(po => {
                const option = document.createElement('option');
                option.value = po;
                datalist.appendChild(option);
            });

            // Populate HRC Batch
            const batches = [...new Set(allBundles.map(b => b.batch_No).filter(b => b))];
            const cmbHRC = document.getElementById('cmbHRCBatch');
            cmbHRC.innerHTML = '<option value="">Select</option>';
            batches.forEach(batch => {
                const option = document.createElement('option');
                option.value = batch;
                option.textContent = batch;
                cmbHRC.appendChild(option);
            });

            // Populate Slit No
            const slits = [...new Set(allBundles.map(b => b.po_Plan_ID).filter(s => s))];
            const cmbSlit = document.getElementById('cmbSlitNo');
            cmbSlit.innerHTML = '<option value="">Select</option>';
            slits.forEach(slit => {
                const option = document.createElement('option');
                option.value = slit;
                option.textContent = slit;
                cmbSlit.appendChild(option);
            });
        }

        function applyFilters() {
            filteredBundles = [...allBundles];

            // Date filter
            const fromDate = new Date(document.getElementById('dtpFrom').value);
            const toDate = new Date(document.getElementById('dtpTo').value);
            filteredBundles = filteredBundles.filter(b => {
                const startTime = new Date(b.bundleStartTime);
                return startTime >= fromDate && startTime <= toDate;
            });

            // PO filter
            const poFilter = document.getElementById('txtPO').value;
            if (poFilter) {
                filteredBundles = filteredBundles.filter(b => {
                    const poNo = b.po_No || 'N/A';
                    return poNo.toLowerCase().includes(poFilter.toLowerCase());
                });
            }

            // Search filter
            const searchText = document.getElementById('txtSearch').value.toLowerCase();
            if (searchText) {
                filteredBundles = filteredBundles.filter(b => {
                    return (b.bundle_No || '').toLowerCase().includes(searchText) ||
                           (b.batch_No || '').toLowerCase().includes(searchText) ||
                           (b.po_No || 'N/A').toLowerCase().includes(searchText);
                });
            }

            renderGrid();
            updateStatusBar();
        }

        function renderGrid() {
            const container = document.getElementById('gridContainer');
            
            if (filteredBundles.length === 0) {
                container.innerHTML = '<div class="no-data">No bundles found. Adjust filters or add NDT cuts.</div>';
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th onclick="sortGrid(\'bundle_No\')">Bundle No.</th>';
            html += '<th onclick="sortGrid(\'batch_No\')">Batch No.</th>';
            html += '<th onclick="sortGrid(\'po_No\')">PO Number</th>';
            html += '<th onclick="sortGrid(\'ndt_Pcs\')" class="number">NDT Pcs</th>';
            html += '<th onclick="sortGrid(\'bundle_Wt\')" class="number">Bundle Wt (Tons)</th>';
            html += '<th onclick="sortGrid(\'status\')">Status</th>';
            html += '<th onclick="sortGrid(\'bundleStartTime\')" class="number">Bundle Start Time</th>';
            html += '<th onclick="sortGrid(\'bundleEndTime\')" class="number">Bundle End Time</th>';
            html += '<th onclick="sortGrid(\'oprDoneTime\')" class="number">Opr Done Time</th>';
            html += '<th onclick="sortGrid(\'isFullBundle\')" class="center">Is Full</th>';
            html += '<th onclick="sortGrid(\'po_Plan_ID\')" class="number">Slit No.</th>';
            html += '</tr></thead><tbody>';

            filteredBundles.forEach(bundle => {
                const status = bundle.status === 1 ? 'Active' : bundle.status === 2 ? 'Completed' : bundle.status === 3 ? 'Printed' : 'Unknown';
                const statusClass = bundle.status === 1 ? 'status-active' : bundle.status === 2 ? 'status-completed' : 'status-printed';
                const isSelected = selectedBundleIds.has(bundle.ndtBundle_ID);
                const rowClass = isSelected ? 'selected' : '';
                
                html += `<tr class="${rowClass}" onclick="toggleSelection(${bundle.ndtBundle_ID}, event)" oncontextmenu="showContextMenu(event, ${bundle.ndtBundle_ID})">`;
                html += `<td class="number">${bundle.bundle_No || ''}</td>`;
                html += `<td>${bundle.batch_No || ''}</td>`;
                html += `<td>${bundle.po_No || 'N/A'}</td>`;
                html += `<td class="number">${bundle.ndt_Pcs}</td>`;
                html += `<td class="number">${bundle.bundle_Wt.toFixed(2)}</td>`;
                html += `<td class="${statusClass}">${status}</td>`;
                html += `<td class="number">${formatDateTime(new Date(bundle.bundleStartTime))}</td>`;
                html += `<td class="number">${bundle.bundleEndTime ? formatDateTime(new Date(bundle.bundleEndTime)) : '-'}</td>`;
                html += `<td class="number">${bundle.oprDoneTime ? formatDateTime(new Date(bundle.oprDoneTime)) : '-'}</td>`;
                html += `<td class="center">${bundle.isFullBundle ? '✓' : ''}</td>`;
                html += `<td class="number">${bundle.po_Plan_ID || ''}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function toggleSelection(bundleId, event) {
            if (event.ctrlKey || event.metaKey) {
                // Multi-select with Ctrl/Cmd
                if (selectedBundleIds.has(bundleId)) {
                    selectedBundleIds.delete(bundleId);
                } else {
                    selectedBundleIds.add(bundleId);
                }
            } else {
                // Single select
                selectedBundleIds.clear();
                selectedBundleIds.add(bundleId);
            }
            renderGrid();
            updateStatusBar();
        }

        function showContextMenu(event, bundleId) {
            event.preventDefault();
            selectedBundleIds.clear();
            selectedBundleIds.add(bundleId);
            renderGrid();
            
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            
            document.addEventListener('click', function hideMenu() {
                menu.style.display = 'none';
                document.removeEventListener('click', hideMenu);
            });
        }

        function toggleShop(button, shopName) {
            if (activeShops.has(shopName)) {
                activeShops.delete(shopName);
                button.classList.remove('active');
            } else {
                activeShops.add(shopName);
                button.classList.add('active');
            }
            applyFilters();
        }

        function sortGrid(column) {
            filteredBundles.sort((a, b) => {
                const aVal = a[column];
                const bVal = b[column];
                if (aVal < bVal) return -1;
                if (aVal > bVal) return 1;
                return 0;
            });
            renderGrid();
        }

        function updateStatusBar() {
            const total = allBundles.length;
            const filtered = filteredBundles.length;
            const selected = selectedBundleIds.size;
            document.getElementById('recordCount').textContent = `Total: ${total} | Filtered: ${filtered} | Selected: ${selected}`;
        }

        function updateStatus(message) {
            document.getElementById('statusMessage').textContent = message;
        }

        async function printSelectedBundles(isReprint) {
            if (selectedBundleIds.size === 0) {
                alert('Please select at least one bundle to print.');
                return;
            }

            const bundleIds = Array.from(selectedBundleIds);
            let successCount = 0;

            for (const bundleId of bundleIds) {
                try {
                    const bundle = allBundles.find(b => b.ndtBundle_ID === bundleId);
                    const response = await fetch(`/api/print/${bundleId}`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                        addActivityLog(`✓ Printed bundle ${bundle?.bundle_No || bundleId} successfully`);
                    } else {
                        addActivityLog(`✗ Failed to print bundle ${bundle?.bundle_No || bundleId}`);
                    }
                } catch (error) {
                    console.error('Print error:', error);
                    addActivityLog(`✗ Error printing bundle: ${error.message}`);
                }
            }

            updateStatus(`Printed ${successCount} of ${bundleIds.length} bundles`);
            await loadBundles();
            refreshSystemStatus();
        }

        function contextPrint(isReprint) {
            printSelectedBundles(isReprint);
        }

        function viewDetails() {
            if (selectedBundleIds.size === 0) return;
            const bundleId = Array.from(selectedBundleIds)[0];
            const bundle = allBundles.find(b => b.ndtBundle_ID === bundleId);
            if (bundle) {
                alert(`Bundle Details:\n\nBundle No: ${bundle.bundle_No}\nBatch No: ${bundle.batch_No}\nNDT Pieces: ${bundle.ndt_Pcs}\nBundle Weight: ${bundle.bundle_Wt} Tons\nStatus: ${bundle.status === 1 ? 'Active' : bundle.status === 2 ? 'Completed' : 'Printed'}`);
            }
        }

        function exportToExcel() {
            // Create CSV content
            let csv = 'Bundle No,Batch No,PO Number,NDT Pcs,Bundle Wt (Tons),Status,Bundle Start Time,Bundle End Time,Opr Done Time,Is Full,Slit No\n';
            
            filteredBundles.forEach(bundle => {
                const status = bundle.status === 1 ? 'Active' : bundle.status === 2 ? 'Completed' : 'Printed';
                csv += `${bundle.bundle_No || ''},${bundle.batch_No || ''},${bundle.po_No || 'N/A'},${bundle.ndt_Pcs},${bundle.bundle_Wt.toFixed(2)},${status},${formatDateTime(new Date(bundle.bundleStartTime))},${bundle.bundleEndTime ? formatDateTime(new Date(bundle.bundleEndTime)) : '-'},${bundle.oprDoneTime ? formatDateTime(new Date(bundle.oprDoneTime)) : '-'},${bundle.isFullBundle ? 'Yes' : 'No'},${bundle.po_Plan_ID || ''}\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `NDTBundleDetails_${new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            updateStatus('Excel export completed');
        }

        function showViewLog() {
            alert('View Log functionality not implemented');
        }

        // System Status Monitoring Functions
        async function refreshSystemStatus() {
            const refreshBtn = document.querySelector('.system-monitor-header .refresh-btn');
            const originalText = refreshBtn ? refreshBtn.textContent : 'Refresh';
            
            // Disable button and show loading state
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Refreshing...';
                refreshBtn.style.opacity = '0.6';
            }
            
            try {
                // Get comprehensive system status
                const response = await fetch('/api/system-status');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Check if there's an error in the response
                if (data.error) {
                    console.error('API returned error:', data.error);
                    addActivityLog('✗ Error refreshing system status: ' + data.error);
                }
                
                // Update PLC Status
                if (data.plc) {
                updatePLCStatusDisplay(data.plc);
                }
                
                // Update Printer Status
                if (data.printer) {
                updatePrinterStatusDisplay(data.printer);
                }
                
                // Update Current Pipe Counts (from PLC)
                if (data.pipeCounts) {
                    document.getElementById('currentOKCount').textContent = data.pipeCounts.currentOKCuts || 0;
                    document.getElementById('currentNDTCount').textContent = data.pipeCounts.currentNDTCuts || 0;
                }
                
                // Update NDT Bundle Statistics (always update, even if 0)
                const ndtCounts = data.ndtCounts || {};
                document.getElementById('totalNDTInBundles').textContent = ndtCounts.totalPipes ?? 0;
                document.getElementById('bundlesCreated').textContent = ndtCounts.bundlesCreated ?? 0;
                document.getElementById('tagsPrinted').textContent = ndtCounts.tagsPrinted ?? 0;
                
                // Update OK Bundle Statistics (always update, even if 0)
                const okCounts = data.okCounts || {};
                document.getElementById('totalOKInBundles').textContent = okCounts.totalPipes ?? 0;
                document.getElementById('okBundlesCreated').textContent = okCounts.bundlesCreated ?? 0;
                document.getElementById('okTagsPrinted').textContent = okCounts.tagsPrinted ?? 0;
                
                // Update Bundle Status (always update, even if 0)
                const bundleStatus = data.bundleStatus || {};
                document.getElementById('activeBundles').textContent = bundleStatus.active ?? 0;
                document.getElementById('readyBundles').textContent = bundleStatus.ready ?? 0;
                document.getElementById('printedBundles').textContent = bundleStatus.printed ?? 0;
                
                // Update test scenario tag counts if active scenario exists
                await checkActiveScenario();
                
                if (!data.error) {
                    addActivityLog('✓ System status refreshed successfully');
                }
                
                // Show success feedback
                if (refreshBtn) {
                    refreshBtn.textContent = '✓ Refreshed';
                    setTimeout(() => {
                        refreshBtn.textContent = originalText;
                    }, 1000);
                }
            } catch (error) {
                console.error('Error refreshing system status:', error);
                addActivityLog('✗ Error refreshing system status: ' + error.message);
                
                // Show error feedback
                if (refreshBtn) {
                    refreshBtn.textContent = '✗ Error';
                    refreshBtn.style.color = '#dc3545';
                    setTimeout(() => {
                        refreshBtn.textContent = originalText;
                        refreshBtn.style.color = '';
                    }, 2000);
                }
                
                // Fallback to individual checks
                try {
                await Promise.all([
                    checkPLCStatus(),
                    checkPrinterStatus(),
                    updateNDTCounts(),
                    updateOKCounts(),
                    updateBundleStatus()
                ]);
                } catch (fallbackError) {
                    console.error('Fallback checks also failed:', fallbackError);
                }
            } finally {
                // Re-enable button
                if (refreshBtn) {
                    setTimeout(() => {
                        refreshBtn.disabled = false;
                        refreshBtn.style.opacity = '1';
                    }, 500);
                }
            }
        }

        // Pipe Counting Activity Functions
        async function refreshPipeActivity() {
            const refreshBtn = document.querySelector('.pipe-counting-activity-header .refresh-btn');
            const originalText = refreshBtn ? refreshBtn.textContent : 'Refresh';
            
            // Disable button and show loading state
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Refreshing...';
                refreshBtn.style.opacity = '0.6';
            }
            
            try {
                const response = await fetch('/api/pipe-counting-activity');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                updatePipeActivityTable(data.activities || []);
                
                // Update current counts in system monitor
                if (data.currentCounts) {
                    document.getElementById('currentOKCount').textContent = data.currentCounts.okCuts || 0;
                    document.getElementById('currentNDTCount').textContent = data.currentCounts.ndtCuts || 0;
                }
                
                addActivityLog('✓ Pipe activity refreshed successfully');
                
                // Show success feedback
                if (refreshBtn) {
                    refreshBtn.textContent = '✓ Refreshed';
                    setTimeout(() => {
                        refreshBtn.textContent = originalText;
                    }, 1000);
                }
            } catch (error) {
                console.error('Error refreshing pipe activity:', error);
                addActivityLog('✗ Error refreshing pipe activity: ' + error.message);
                
                // Show error feedback
                if (refreshBtn) {
                    refreshBtn.textContent = '✗ Error';
                    refreshBtn.style.color = '#dc3545';
                    setTimeout(() => {
                        refreshBtn.textContent = originalText;
                        refreshBtn.style.color = '';
                    }, 2000);
                }
            } finally {
                // Re-enable button
                if (refreshBtn) {
                    setTimeout(() => {
                        refreshBtn.disabled = false;
                        refreshBtn.style.opacity = '1';
                    }, 500);
                }
            }
        }

        function updatePipeActivityTable(activities) {
            const tbody = document.getElementById('pipeActivityBody');
            
            if (activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 20px;">No pipe counting activity yet. Waiting for pipes to be counted...</td></tr>';
                return;
            }
            
            let html = '';
            activities.forEach(activity => {
                const time = new Date(activity.timestamp);
                const timeStr = formatDateTime(time);
                const typeClass = activity.pipeType === 'OK' ? 'pipe-type-ok' : 'pipe-type-ndt';
                
                html += `<tr>
                    <td>${timeStr}</td>
                    <td class="${typeClass}">${activity.pipeType}</td>
                    <td style="font-weight: bold;">+${activity.count}</td>
                    <td>${activity.totalOKCuts}</td>
                    <td>${activity.totalNDTCuts}</td>
                    <td>${activity.source || 'PLC'}</td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }

        function updatePLCStatusDisplay(plcData) {
            const statusDot = document.getElementById('plcStatusDot');
            const statusText = document.getElementById('plcConnectionStatus');
            
            if (plcData.connected) {
                statusDot.className = 'status-dot online';
                statusText.textContent = 'CONNECTED';
                statusText.style.color = '#28a745';
            } else {
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'DISCONNECTED';
                statusText.style.color = '#dc3545';
            }
        }

        function updatePrinterStatusDisplay(printerData) {
            const statusDot = document.getElementById('printerStatusDot');
            const statusText = document.getElementById('printerConnectionStatus');
            
            if (printerData.status === 'connected' || printerData.status === 'ready') {
                statusDot.className = printerData.status === 'connected' ? 'status-dot online' : 'status-dot waiting';
                statusText.textContent = printerData.status === 'connected' ? 'CONNECTED' : 'READY';
                statusText.style.color = printerData.status === 'connected' ? '#28a745' : '#ffc107';
            } else {
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'ERROR';
                statusText.style.color = '#dc3545';
            }
        }

        async function checkPLCStatus() {
            try {
                const response = await fetch('/api/plc/status');
                const data = await response.json();
                
                const statusDot = document.getElementById('plcStatusDot');
                const statusText = document.getElementById('plcConnectionStatus');
                
                if (data.connected) {
                    statusDot.className = 'status-dot online';
                    statusText.textContent = 'CONNECTED';
                    statusText.style.color = '#28a745';
                    addActivityLog('PLC connected successfully');
                } else {
                    statusDot.className = 'status-dot offline';
                    statusText.textContent = 'DISCONNECTED';
                    statusText.style.color = '#dc3545';
                }
            } catch (error) {
                const statusDot = document.getElementById('plcStatusDot');
                const statusText = document.getElementById('plcConnectionStatus');
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'ERROR';
                statusText.style.color = '#dc3545';
                addActivityLog('Error checking PLC status: ' + error.message);
            }
        }

        async function checkPrinterStatus() {
            // Test printer by attempting a connection check
            // For now, we'll check if test print works
            const statusDot = document.getElementById('printerStatusDot');
            const statusText = document.getElementById('printerConnectionStatus');
            
            // Since we can't directly ping the printer from browser,
            // we'll mark it as "Ready" and test on actual print
            statusDot.className = 'status-dot waiting';
            statusText.textContent = 'READY';
            statusText.style.color = '#ffc107';
        }

        async function updateNDTCounts() {
            try {
                // Get bundles data
                const bundlesResponse = await fetch('/api/bundles');
                const bundles = await bundlesResponse.json();
                
                // Calculate statistics
                const totalNDTPcs = bundles.reduce((sum, b) => sum + (b.ndt_Pcs || 0), 0);
                const printedCount = bundles.filter(b => b.status === 3).length;
                
                document.getElementById('totalNDTInBundles').textContent = totalNDTPcs;
                document.getElementById('bundlesCreated').textContent = bundles.length;
                document.getElementById('tagsPrinted').textContent = printedCount;
                
                // Update bundle status
                updateBundleStatus();
            } catch (error) {
                console.error('Error updating NDT counts:', error);
            }
        }

        async function updateOKCounts() {
            try {
                // Get OK bundles data
                const bundlesResponse = await fetch('/api/ok-bundles');
                const bundles = await bundlesResponse.json();
                
                // Calculate statistics - handle both camelCase and snake_case property names
                const totalOKPcs = bundles.reduce((sum, b) => sum + (b.ok_Pcs || b.okPcs || 0), 0);
                const printedCount = bundles.filter(b => (b.status === 3 || b.Status === 3)).length;
                
                document.getElementById('totalOKInBundles').textContent = totalOKPcs;
                document.getElementById('okBundlesCreated').textContent = bundles.length;
                document.getElementById('okTagsPrinted').textContent = printedCount;
            } catch (error) {
                console.error('Error updating OK counts:', error);
            }
        }

        function updateBundleStatus() {
            const active = allBundles.filter(b => b.status === 1).length;
            const ready = allBundles.filter(b => b.status === 2).length;
            const printed = allBundles.filter(b => b.status === 3).length;
            
            document.getElementById('activeBundles').textContent = active;
            document.getElementById('readyBundles').textContent = ready;
            document.getElementById('printedBundles').textContent = printed;
        }

        function addActivityLog(message) {
            const log = document.getElementById('activityLog');
            const entry = document.createElement('div');
            entry.className = 'activity-log-entry';
            
            const time = new Date();
            const timeStr = time.toLocaleTimeString();
            
            entry.innerHTML = `<span class="activity-log-time">[${timeStr}]</span>${message}`;
            
            log.insertBefore(entry, log.firstChild);
            
            // Keep only last 50 entries
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }


        // Enhanced loadBundles to add activity log
        const originalLoadBundles = loadBundles;
        loadBundles = async function() {
            await originalLoadBundles();
            updateBundleStatus();
            updateNDTCounts();
        };

        // Monitor for new bundles and status changes (check every 3 seconds)
        setInterval(async function() {
            try {
                const response = await fetch('/api/bundles');
                const newBundles = await response.json();
                
                // Check for new bundles
                if (newBundles.length !== allBundles.length) {
                    const newCount = newBundles.length - allBundles.length;
                    if (newCount > 0) {
                        addActivityLog(`✓ New bundle created: ${newCount} bundle(s) added`);
                        await loadBundles();
                        refreshSystemStatus();
                    }
                }
                
                // Check for status changes
                newBundles.forEach(newBundle => {
                    const oldBundle = allBundles.find(b => b.ndtBundle_ID === newBundle.ndtBundle_ID);
                    if (oldBundle && oldBundle.status !== newBundle.status) {
                        if (newBundle.status === 2) {
                            addActivityLog(`✓ Bundle ${newBundle.bundle_No} ready for printing (${newBundle.ndt_Pcs} pipes)`);
                        } else if (newBundle.status === 3) {
                            addActivityLog(`✓ Bundle ${newBundle.bundle_No} printed successfully`);
                        }
                    }
                });
                
                // Update allBundles for next comparison
                allBundles = newBundles;
            } catch (error) {
                console.error('Error checking for new bundles:', error);
            }
        }, 3000);

        // PO Plan Management Functions
        let currentPOPlanId = null;
        let allPOPlans = [];

        async function openPOPlanManagement() {
            document.getElementById('poPlanModal').style.display = 'block';
            await loadPOPlans();
        }

        function closePOPlanModal() {
            document.getElementById('poPlanModal').style.display = 'none';
        }

        async function loadPOPlans() {
            try {
                const response = await fetch('/api/po-plans');
                const data = await response.json();
                
                // Ensure we have an array - handle both array and object responses
                if (Array.isArray(data)) {
                    allPOPlans = data;
                } else if (data && Array.isArray(data.data)) {
                    allPOPlans = data.data;
                } else if (data && data.success === false) {
                    // Error response - use empty array
                    console.warn('PO Plans API returned error:', data.message);
                    allPOPlans = [];
                } else {
                    // Unexpected format - default to empty array
                    console.warn('Unexpected PO Plans response format:', data);
                    allPOPlans = [];
                }
                
                displayPOPlans(allPOPlans);
            } catch (error) {
                console.error('Error loading PO Plans:', error);
                allPOPlans = []; // Set to empty array on error
                displayPOPlans(allPOPlans); // Display empty list
                alert('Error loading PO Plans: ' + error.message + '\n\nThis may be due to database connection issues. Please check your connection string in appsettings.json');
            }
        }

        function displayPOPlans(poPlans) {
            const tbody = document.getElementById('poPlanTableBody');
            
            // Ensure poPlans is an array
            if (!Array.isArray(poPlans)) {
                console.error('displayPOPlans: poPlans is not an array:', poPlans);
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: red;">Error: Invalid data format. Expected array but got: ' + typeof poPlans + '</td></tr>';
                return;
            }
            
            if (poPlans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666;">No PO Plans found. Click "Add New PO Plan" to create one.</td></tr>';
                return;
            }
            
            tbody.innerHTML = poPlans.map(plan => {
                const id = plan.pO_Plan_ID || plan.po_Plan_ID || plan.pOPlan_ID || plan.poPlan_ID || '';
                const plcPoid = plan.pLC_POID || plan.plc_POID || plan.pLCPOID || plan.plcPOID || '';
                const poNo = plan.pO_No || plan.po_No || plan.pONo || plan.poNo || '';
                const pipeType = plan.pipe_Type || plan.pipeType || '';
                const pipeSize = plan.pipe_Size || plan.pipeSize || '';
                const pcsPerBundle = plan.pcsPerBundle || 0;
                const pipeLen = plan.pipe_Len || plan.pipeLen || 0;
                const pipeWt = plan.pipeWt_per_mtr || plan.pipeWtPerMtr || plan.pipeWt_perMtr || 0;
                const sapType = plan.sAP_Type || plan.sapType || plan.sAPType || '';
                const shopId = plan.shop_ID || plan.shopId || plan.shop_ID || '';
                return `
                <tr>
                    <td>${id}</td>
                    <td>${plcPoid}</td>
                    <td>${poNo}</td>
                    <td>${pipeType}</td>
                    <td>${pipeSize}</td>
                    <td>${pcsPerBundle}</td>
                    <td>${parseFloat(pipeLen).toFixed(2)}</td>
                    <td>${parseFloat(pipeWt).toFixed(2)}</td>
                    <td>${sapType}</td>
                    <td>${shopId}</td>
                    <td>
                        <button class="btn btn-primary" onclick="openPOPlanEditDialog(${id})" style="margin-right: 5px;">Edit</button>
                        <button class="btn btn-danger" onclick="deletePOPlan(${id})">Delete</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function filterPOPlans() {
            const search = document.getElementById('poPlanSearch').value.toLowerCase();
            const filtered = allPOPlans.filter(plan => {
                const poNo = (plan.pO_No || plan.po_No || '').toLowerCase();
                const pipeType = (plan.pipe_Type || plan.pipeType || '').toLowerCase();
                const pipeSize = (plan.pipe_Size || plan.pipeSize || '').toLowerCase();
                const sapType = (plan.sAP_Type || plan.sapType || '').toLowerCase();
                return poNo.includes(search) || pipeType.includes(search) || 
                       pipeSize.includes(search) || sapType.includes(search);
            });
            displayPOPlans(filtered);
        }

        async function openPOPlanEditDialog(id) {
            currentPOPlanId = id;
            const modal = document.getElementById('poPlanEditModal');
            const title = document.getElementById('poPlanEditTitle');
            
            if (id) {
                title.textContent = 'Edit PO Plan';
                try {
                    const response = await fetch(`/api/po-plans/${id}`);
                    const plan = await response.json();
                    document.getElementById('editPLC_POID').value = plan.pLC_POID || plan.plc_POID || plan.pLCPOID || plan.plcPOID || '';
                    document.getElementById('editPO_No').value = plan.pO_No || plan.po_No || plan.pONo || plan.poNo || '';
                    document.getElementById('editPipe_Type').value = plan.pipe_Type || plan.pipeType || '';
                    document.getElementById('editPipe_Size').value = plan.pipe_Size || plan.pipeSize || '';
                    document.getElementById('editPcsPerBundle').value = plan.pcsPerBundle || 0;
                    document.getElementById('editPipe_Len').value = plan.pipe_Len || plan.pipeLen || 0;
                    document.getElementById('editPipeWt_per_mtr').value = plan.pipeWt_per_mtr || plan.pipeWtPerMtr || plan.pipeWt_perMtr || 0;
                    document.getElementById('editSAP_Type').value = plan.sAP_Type || plan.sapType || plan.sAPType || '';
                    document.getElementById('editShop_ID').value = plan.shop_ID || plan.shopId || plan.shop_ID || 0;
                } catch (error) {
                    console.error('Error loading PO Plan:', error);
                    alert('Error loading PO Plan: ' + error.message);
                    return;
                }
            } else {
                title.textContent = 'Add New PO Plan';
                document.getElementById('poPlanEditForm').reset();
            }
            modal.style.display = 'block';
        }

        function closePOPlanEditModal() {
            document.getElementById('poPlanEditModal').style.display = 'none';
            currentPOPlanId = null;
        }

        async function savePOPlan() {
            const poNoValue = document.getElementById('editPO_No').value?.trim();
            
            if (!poNoValue) {
                alert('PO Number is required');
                document.getElementById('editPO_No').focus();
                return;
            }

            const plan = {
                PO_Plan_ID: currentPOPlanId || 0,
                PLC_POID: document.getElementById('editPLC_POID').value ? parseInt(document.getElementById('editPLC_POID').value) : null,
                PO_No: poNoValue,
                Pipe_Type: document.getElementById('editPipe_Type').value?.trim() || null,
                Pipe_Size: document.getElementById('editPipe_Size').value?.trim() || null,
                PcsPerBundle: parseInt(document.getElementById('editPcsPerBundle').value) || 0,
                Pipe_Len: parseFloat(document.getElementById('editPipe_Len').value) || 0,
                PipeWt_per_mtr: parseFloat(document.getElementById('editPipeWt_per_mtr').value) || 0,
                SAP_Type: document.getElementById('editSAP_Type').value?.trim() || null,
                Shop_ID: document.getElementById('editShop_ID').value ? parseInt(document.getElementById('editShop_ID').value) : null
            };

            try {
                let response;
                if (currentPOPlanId) {
                    response = await fetch(`/api/po-plans/${currentPOPlanId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(plan)
                    });
                } else {
                    response = await fetch('/api/po-plans', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(plan)
                    });
                }

                const result = await response.json();
                if (result.success !== false) {
                    alert(currentPOPlanId ? 'PO Plan updated successfully' : 'PO Plan added successfully');
                    closePOPlanEditModal();
                    await loadPOPlans();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving PO Plan:', error);
                alert('Error saving PO Plan: ' + error.message);
            }
        }

        async function deletePOPlan(id) {
            if (!confirm('Are you sure you want to delete this PO Plan?')) {
                return;
            }

            try {
                const response = await fetch(`/api/po-plans/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success !== false) {
                    alert('PO Plan deleted successfully');
                    await loadPOPlans();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting PO Plan:', error);
                alert('Error deleting PO Plan: ' + error.message);
            }
        }

        function refreshPOPlans() {
            loadPOPlans();
        }

        // PLC Polling Control Functions
        let isPollingActive = false;

        async function togglePLCPolling() {
            const btn = document.getElementById('btnPLCPolling');
            
            // Disable button during operation
            btn.disabled = true;
            
            try {
            if (isPollingActive) {
                    // Stop polling
                    const response = await fetch('/api/plc/polling/stop', {
                        method: 'POST'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                isPollingActive = false;
                btn.textContent = 'Start PLC Polling';
                btn.className = 'btn btn-success';
                        addActivityLog('PLC polling stopped');
                        updateStatus('PLC polling stopped');
                    } else {
                        alert('Failed to stop polling: ' + (result.message || 'Unknown error'));
                    }
            } else {
                // Start polling
                    const response = await fetch('/api/plc/polling/start', {
                        method: 'POST'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                isPollingActive = true;
                btn.textContent = 'Stop PLC Polling';
                btn.className = 'btn btn-danger';
                        addActivityLog('PLC polling started');
                        updateStatus('PLC polling started');
                    } else {
                        alert('Failed to start polling: ' + (result.message || 'Unknown error'));
                    }
                }
            } catch (error) {
                console.error('Error toggling PLC polling:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
            }
        }

        // Check polling status on page load and periodically
        async function checkPollingStatus() {
            try {
                const response = await fetch('/api/plc/polling/status');
                const result = await response.json();
                
                const btn = document.getElementById('btnPLCPolling');
                isPollingActive = result.isPolling || false;
                
                if (isPollingActive) {
                    btn.textContent = 'Stop PLC Polling';
                    btn.className = 'btn btn-danger';
                } else {
                    btn.textContent = 'Start PLC Polling';
                    btn.className = 'btn btn-success';
                }
            } catch (error) {
                console.error('Error checking polling status:', error);
            }
        }

        // Test Scenario Management Functions
        const testScenarios = [
            {
                name: "CASE1",
                displayName: "Case 1: Single OK + Multiple NDT",
                pipeSize: "8.0",
                okPcsPerBundle: 42,
                ndtPcsPerBundle: 13,
                expectedOKTags: 1,
                expectedNDTTags: 2,
                expectedOK: "1 full (42)",
                expectedNDT: "2 full (13+13) + 1 partial (4)"
            },
            {
                name: "CASE2",
                displayName: "Case 2: Multiple OK + Single NDT",
                pipeSize: "6.0",
                okPcsPerBundle: 21,
                ndtPcsPerBundle: 20,
                expectedOKTags: 2,
                expectedNDTTags: 1,
                expectedOK: "2 full (21+21)",
                expectedNDT: "1 full (20) + 1 partial (10)"
            },
            {
                name: "CASE3",
                displayName: "Case 3: Multiple OK + Multiple NDT",
                pipeSize: "5.0",
                okPcsPerBundle: 14,
                ndtPcsPerBundle: 25,
                expectedOKTags: 3,
                expectedNDTTags: 1,
                expectedOK: "3 full (14+14+14)",
                expectedNDT: "1 full (25) + 1 partial (5)"
            },
            {
                name: "CASE4",
                displayName: "Case 4: Partial Bundles",
                pipeSize: "3.0",
                okPcsPerBundle: 50,
                ndtPcsPerBundle: 45,
                expectedOKTags: 1,
                expectedNDTTags: 1,
                expectedOK: "1 partial (42)*",
                expectedNDT: "1 partial (30)*"
            },
            {
                name: "CASE5",
                displayName: "Case 5: Default NDT Size",
                pipeSize: "NULL",
                okPcsPerBundle: 42,
                ndtPcsPerBundle: 20,
                expectedOKTags: 1,
                expectedNDTTags: 1,
                expectedOK: "1 full (42)",
                expectedNDT: "1 full (20) + 1 partial (10)"
            }
        ];

        async function openTestScenarioManager() {
            document.getElementById('testScenarioModal').style.display = 'block';
            await checkActiveScenario();
            await loadTestScenarios();
            await refreshTagCounts();
        }
        
        async function refreshTagCounts() {
            await checkActiveScenario();
            await loadTestScenarios();
        }

        function closeTestScenarioModal() {
            document.getElementById('testScenarioModal').style.display = 'none';
        }

        async function loadTestScenarios() {
            const tbody = document.getElementById('testScenarioTableBody');
            
            // Get actual tag counts (use scenario-specific counts if available)
            let actualOKTags = 0;
            let actualNDTTags = 0;
            try {
                const statusResponse = await fetch('/api/system-status');
                const statusData = await statusResponse.json();
                // Use activeScenarioCounts if available (filtered by active PO Plan), otherwise fall back to global counts
                actualOKTags = statusData.activeScenarioCounts?.okTagsPrinted ?? statusData.okCounts?.tagsPrinted ?? 0;
                actualNDTTags = statusData.activeScenarioCounts?.ndtTagsPrinted ?? statusData.ndtCounts?.tagsPrinted ?? 0;
            } catch (error) {
                console.error('Error fetching tag counts:', error);
            }
            
            tbody.innerHTML = testScenarios.map(scenario => {
                // Check if this is the active scenario
                const isActive = document.getElementById('currentActiveScenario').textContent.includes(scenario.displayName);
                const rowStyle = isActive ? 'background-color: #e7f3ff;' : '';
                
                return `
                <tr style="${rowStyle}">
                    <td><strong>${scenario.displayName}</strong>${isActive ? ' <span style="color: #28a745;">(Active)</span>' : ''}</td>
                    <td>${scenario.pipeSize}</td>
                    <td>${scenario.okPcsPerBundle}</td>
                    <td>${scenario.ndtPcsPerBundle}</td>
                    <td style="text-align: center;">
                        <span style="font-weight: bold; color: #0078D7; font-size: 11pt;">${scenario.expectedOKTags}</span>
                        ${isActive ? `<br><small style="color: #666;">Actual: <span id="scenario_${scenario.name}_ok">${actualOKTags}</span></small>` : ''}
                    </td>
                    <td style="text-align: center;">
                        <span style="font-weight: bold; color: #dc3545; font-size: 11pt;">${scenario.expectedNDTTags}</span>
                        ${isActive ? `<br><small style="color: #666;">Actual: <span id="scenario_${scenario.name}_ndt">${actualNDTTags}</span></small>` : ''}
                    </td>
                    <td style="font-size: 8pt; color: #666;">${scenario.expectedOK}</td>
                    <td style="font-size: 8pt; color: #666;">${scenario.expectedNDT}</td>
                    <td>
                        <button class="btn btn-success" onclick="activateTestScenario('${scenario.name}')">
                            Start Scenario
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        async function activateTestScenario(scenarioName) {
            const scenario = testScenarios.find(s => s.name === scenarioName);
            const scenarioDisplayName = scenario ? scenario.displayName : scenarioName;
            
            if (!confirm(`Activate test scenario "${scenarioDisplayName}"?\n\nThis will:\n- Close the current active PO\n- Activate this test scenario\n- Create/activate the PO Plan and Slit for testing`)) {
                return;
            }

            try {
                const response = await fetch(`/api/test-scenarios/activate/${scenarioName}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    alert(`✓ Test scenario "${scenarioDisplayName}" activated successfully!\n\nPO: ${result.poPlan.po_No}\nPipe Size: ${result.poPlan.pipe_Size || 'NULL'}\nPcsPerBundle: ${result.poPlan.pcsPerBundle}\n\nYou can now start PLC polling to test with OK=42 and NDT=30.`);
                    await checkActiveScenario();
                    addActivityLog(`✓ Test scenario ${scenarioName} (${scenarioDisplayName}) activated`);
                    // Refresh bundles and status
                    await loadBundles();
                    refreshSystemStatus();
                    closeTestScenarioModal();
                } else {
                    alert('Error: ' + result.message);
                    addActivityLog('✗ Failed to activate test scenario: ' + result.message);
                }
            } catch (error) {
                console.error('Error activating scenario:', error);
                alert('Error activating scenario: ' + error.message);
                addActivityLog('✗ Error activating test scenario: ' + error.message);
            }
        }

        async function checkActiveScenario() {
            try {
                const response = await fetch('/api/test-scenarios/active');
                const data = await response.json();
                
                const currentScenarioElement = document.getElementById('currentActiveScenario');
                const tagCountSummary = document.getElementById('tagCountSummary');
                
                if (data.activeScenario) {
                    const scenario = testScenarios.find(s => s.name === data.activeScenario);
                    if (scenario) {
                        currentScenarioElement.textContent = scenario.displayName;
                        currentScenarioElement.style.color = '#28a745';
                        
                        // Show tag count summary in modal
                        tagCountSummary.style.display = 'block';
                        document.getElementById('expectedOKTags').textContent = scenario.expectedOKTags;
                        document.getElementById('expectedNDTTags').textContent = scenario.expectedNDTTags;
                        
                        // Show tag count card in system monitor
                        const tagCard = document.getElementById('testScenarioTagCard');
                        if (tagCard) {
                            tagCard.style.display = 'block';
                            document.getElementById('monitorActiveScenario').textContent = scenario.displayName;
                            document.getElementById('monitorExpectedOK').textContent = scenario.expectedOKTags;
                            document.getElementById('monitorExpectedNDT').textContent = scenario.expectedNDTTags;
                        }
                        
                        // Get actual tag counts (use scenario-specific counts if available)
                        try {
                            const statusResponse = await fetch('/api/system-status');
                            const statusData = await statusResponse.json();
                            // Use activeScenarioCounts if available (filtered by active PO Plan), otherwise fall back to global counts
                            const actualOK = statusData.activeScenarioCounts?.okTagsPrinted ?? statusData.okCounts?.tagsPrinted ?? 0;
                            const actualNDT = statusData.activeScenarioCounts?.ndtTagsPrinted ?? statusData.ndtCounts?.tagsPrinted ?? 0;
                            
                            // Update modal
                            document.getElementById('actualOKTags').textContent = actualOK;
                            document.getElementById('actualNDTTags').textContent = actualNDT;
                            
                            // Update system monitor
                            if (tagCard) {
                                document.getElementById('monitorActualOK').textContent = actualOK;
                                document.getElementById('monitorActualNDT').textContent = actualNDT;
                            }
                            
                            // Update match indicators in modal
                            const okMatch = document.getElementById('okTagsMatch');
                            const ndtMatch = document.getElementById('ndtTagsMatch');
                            
                            if (actualOK === scenario.expectedOKTags) {
                                okMatch.textContent = '✓';
                                okMatch.style.color = '#28a745';
                            } else {
                                okMatch.textContent = '⚠';
                                okMatch.style.color = '#ffc107';
                            }
                            
                            if (actualNDT === scenario.expectedNDTTags) {
                                ndtMatch.textContent = '✓';
                                ndtMatch.style.color = '#28a745';
                            } else {
                                ndtMatch.textContent = '⚠';
                                ndtMatch.style.color = '#ffc107';
                            }
                            
                            // Update match indicators in system monitor
                            if (tagCard) {
                                const monitorOKMatch = document.getElementById('monitorOKMatch');
                                const monitorNDTMatch = document.getElementById('monitorNDTMatch');
                                
                                if (actualOK === scenario.expectedOKTags) {
                                    monitorOKMatch.textContent = '✓';
                                    monitorOKMatch.style.color = '#28a745';
                                } else {
                                    monitorOKMatch.textContent = '⚠';
                                    monitorOKMatch.style.color = '#ffc107';
                                }
                                
                                if (actualNDT === scenario.expectedNDTTags) {
                                    monitorNDTMatch.textContent = '✓';
                                    monitorNDTMatch.style.color = '#28a745';
                                } else {
                                    monitorNDTMatch.textContent = '⚠';
                                    monitorNDTMatch.style.color = '#ffc107';
                                }
                            }
                        } catch (error) {
                            console.error('Error fetching tag counts:', error);
                        }
                    } else {
                        currentScenarioElement.textContent = data.activeScenario;
                        currentScenarioElement.style.color = '#28a745';
                        tagCountSummary.style.display = 'none';
                        const tagCard = document.getElementById('testScenarioTagCard');
                        if (tagCard) tagCard.style.display = 'none';
                    }
                } else {
                    currentScenarioElement.textContent = 'None';
                    currentScenarioElement.style.color = '#666';
                    tagCountSummary.style.display = 'none';
                    const tagCard = document.getElementById('testScenarioTagCard');
                    if (tagCard) tagCard.style.display = 'none';
                }
                
                // Reload scenarios table to update active indicator
                if (document.getElementById('testScenarioModal').style.display === 'block') {
                    await loadTestScenarios();
                }
            } catch (error) {
                console.error('Error checking active scenario:', error);
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const poPlanModal = document.getElementById('poPlanModal');
            const poPlanEditModal = document.getElementById('poPlanEditModal');
            const testScenarioModal = document.getElementById('testScenarioModal');
            if (event.target === poPlanModal) {
                closePOPlanModal();
            }
            if (event.target === poPlanEditModal) {
                closePOPlanEditModal();
            }
            if (event.target === testScenarioModal) {
                closeTestScenarioModal();
            }
        }
    </script>
</body>
</html>
